# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  config.vm.define "yaesm-pytest" do |config| 
    
    config.vm.box = "alvistack/ubuntu-24.04" # supports libvirt, and 24.04 is lts

    # rsync is one-way, so modifications on guest don't affect host
    config.vm.synced_folder ".", "/home/vagrant/yaesm", type: "rsync",
      rsync__exclude: [ ".git/", ".vagrant/" ],
      rsync__args: ["--verbose", "--archive", "--delete", "-z", "--links", "--safe-links"]

    config.vm.provision "shell", inline: <<-SHELL
      set -e

      apt-get update -y
      apt-get upgrade -y

      # OPENSSH (already installed)
      ssh-keyscan localhost >~/.ssh/known_hosts 2>/dev/null
      chmod 0600 ~/.ssh/known_hosts

      # PYTHON
      apt-get install -y python3 python3-venv

      # RSYNC (already installed)
      ###apt-get install -y rsync

      # BTRFS
      apt-get install -y btrfs-progs

      # ZFS
      apt-get install -y zfsutils-linux

      # PYTEST ENV
      (
        su vagrant
        python3 -m venv /home/vagrant/yaesm-venv
        . /home/vagrant/yaesm-venv/bin/activate
        pip3 install -e "/home/vagrant/yaesm[test]"
      )
    SHELL
  end
end
